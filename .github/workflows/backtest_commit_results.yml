name: Backtest BTC 1h Long (commit results)

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Símbolo (MEXC perp), ex: BTC_USDT"
        required: true
        default: "BTC_USDT"
      timeframe:
        description: "Timeframe"
        required: true
        default: "1h"
      min_trades:
        description: "Min trades para relatórios"
        required: true
        default: "30"
      rr_list:
        description: "RRs CSV"
        required: true
        default: "1.0,1.5,2.0,3.0"
      results_branch:
        description: "Branch para salvar results/"
        required: true
        default: "backtest-results"

  schedule:
    - cron: "0 3 * * *"

# Evita duas execuções concorrentes brigarem pelo push
concurrency:
  group: backtest-results
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      SYMBOL: ${{ inputs.symbol || 'BTC_USDT' }}
      TIMEFRAME: ${{ inputs.timeframe || '1h' }}
      MIN_TRADES: ${{ inputs.min_trades || '30' }}
      RR_LIST: ${{ inputs.rr_list || '1.0,1.5,2.0,3.0' }}
      RESULTS_BRANCH: ${{ inputs.results_branch || 'backtest-results' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy requests
          fi

      - name: Run backtest
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          python backtest.py \
            --symbol "$SYMBOL" \
            --timeframe "$TIMEFRAME" \
            --only_long 1 \
            --max_entry_wait 1 \
            --tick_size 0.1 \
            --rr_list "$RR_LIST"

      - name: Debug - list results after backtest
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "List results/:"
          ls -la results || true
          echo ""
          echo "Head summary:"
          SUMMARY="results/backtest_summary_${SYMBOL}_${TIMEFRAME}_long.csv"
          if [ -f "$SUMMARY" ]; then
            head -n 50 "$SUMMARY" || true
          else
            echo "Summary not found: $SUMMARY"
          fi
          echo ""
          echo "Head debug:"
          DBG="results/backtest_debug_${SYMBOL}_${TIMEFRAME}_long.csv"
          if [ -f "$DBG" ]; then
            head -n 50 "$DBG" || true
          else
            echo "Debug not found: $DBG"
          fi

      - name: Run analyze patterns
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          TRADES_FILE="results/backtest_trades_${SYMBOL}_${TIMEFRAME}_long.csv"
          if [ ! -f "$TRADES_FILE" ]; then
            echo "ERRO: não encontrei $TRADES_FILE"
            ls -la results || true
            exit 1
          fi
          python analyze_patterns.py --trades "$TRADES_FILE" --min_trades "$MIN_TRADES"

      - name: Generate results/LATEST.md
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail

          REPO="${GITHUB_REPOSITORY}"
          RUN_URL="https://github.com/${REPO}/actions/runs/${GITHUB_RUN_ID}"
          BRANCH="${RESULTS_BRANCH}"

          SUMMARY="results/backtest_summary_${SYMBOL}_${TIMEFRAME}_long.csv"
          TRADES="results/backtest_trades_${SYMBOL}_${TIMEFRAME}_long.csv"
          BEST="results/patterns_best_${SYMBOL}_${TIMEFRAME}_long.md"
          UNI="results/patterns_univariate_${SYMBOL}_${TIMEFRAME}_long.csv"
          PAIR="results/patterns_pairwise_${SYMBOL}_${TIMEFRAME}_long.csv"
          DEBUG="results/backtest_debug_${SYMBOL}_${TIMEFRAME}_long.csv"

          # Links diretos (na branch de results)
          link() { echo "https://github.com/${REPO}/blob/${BRANCH}/$1"; }

          {
            echo "# LATEST (Backtest Results)"
            echo
            echo "- Repo: \`${REPO}\`"
            echo "- Branch de resultados: \`${BRANCH}\`"
            echo "- Workflow run: ${RUN_URL}"
            echo "- Gerado em (UTC): $(date -u '+%Y-%m-%d %H:%M:%S')"
            echo
            echo "## Arquivos principais"
            echo
            echo "- Summary: $(link "${SUMMARY}")"
            echo "- Trades: $(link "${TRADES}")"
            echo "- Patterns best (.md): $(link "${BEST}")"
            echo "- Patterns univariate (.csv): $(link "${UNI}")"
            echo "- Patterns pairwise (.csv): $(link "${PAIR}")"
            echo "- Debug: $(link "${DEBUG}")"
            echo
            echo "## Resumo (winrate)"
            echo
          } > results/LATEST.md

          # Adiciona uma tabela markdown simples (sem depender de tabulate)
          python - << 'PY' >> results/LATEST.md
import pandas as pd
import os

summary = os.environ.get("SUMMARY_PATH", "")
if not summary:
    summary = "results/backtest_summary_BTC_USDT_1h_long.csv"

df = pd.read_csv(summary)
cols = ["setup", "rr", "trades", "wins", "losses", "win_rate_pct"]
df = df[cols]

# markdown table manual
print("| " + " | ".join(cols) + " |")
print("|" + "|".join(["---"] * len(cols)) + "|")
for _, r in df.iterrows():
    row = [str(r[c]) for c in cols]
    print("| " + " | ".join(row) + " |")
PY
        env:
          SUMMARY_PATH: results/backtest_summary_${{ env.SYMBOL }}_${{ env.TIMEFRAME }}_long.csv

      - name: Commit results/ to results branch (checkout-safe)
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail

          # 1) Snapshot fora do repo
          rm -rf /tmp/results_snapshot
          mkdir -p /tmp/results_snapshot
          cp -r results /tmp/results_snapshot/results

          # 2) Limpa working tree para permitir checkout (remove tracked changes e untracked)
          git reset --hard
          git clean -fd

          # 3) Config git user
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 4) Atualiza remoto e faz checkout baseado na ponta remota (se existir)
          git fetch origin "$RESULTS_BRANCH" || true

          if git show-ref --verify --quiet "refs/remotes/origin/${RESULTS_BRANCH}"; then
            git checkout -B "$RESULTS_BRANCH" "origin/${RESULTS_BRANCH}"
          else
            git checkout -B "$RESULTS_BRANCH"
          fi

          # 5) Restaura results do snapshot
          rm -rf results
          cp -r /tmp/results_snapshot/results results

          # 6) Commit/push
          git add results/
          if git diff --cached --quiet; then
            echo "No changes in results/. Nothing to commit."
            exit 0
          fi

          git commit -m "Backtest ${SYMBOL} ${TIMEFRAME} long (RR=${RR_LIST}) [run ${GITHUB_RUN_ID}]"
          git push origin "$RESULTS_BRANCH"
