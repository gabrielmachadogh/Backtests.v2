name: Backtest BTC 1h Long (commit results)

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Símbolo (MEXC perp), ex: BTC_USDT"
        required: true
        default: "BTC_USDT"
      timeframe:
        description: "Timeframe (apenas 1h)"
        required: true
        default: "1h"
      min_trades:
        description: "Min trades para relatórios de padrões"
        required: true
        default: "30"
      rr_list:
        description: "Lista de RRs (CSV), ex: 1.0,1.5,2.0,3.0"
        required: true
        default: "1.0,1.5,2.0,3.0"
      results_branch:
        description: "Branch onde salvar results/"
        required: true
        default: "backtest-results"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy requests
          fi

      - name: Run backtest
        shell: bash
        working-directory: ${{ github.workspace }}
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -euo pipefail
          python backtest.py \
            --symbol "${{ inputs.symbol }}" \
            --timeframe "${{ inputs.timeframe }}" \
            --only_long 1 \
            --max_entry_wait 1 \
            --rr_list "${{ inputs.rr_list }}"

      - name: Debug - list generated files
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          echo "Tree (depth 3):"
          find . -maxdepth 3 -type f | sort
          echo ""
          echo "Results folder:"
          ls -la results || true
          echo ""
          echo "Trades candidates:"
          find . -type f -name "backtest_trades_*_long.csv" | sort || true

      - name: Run analyze patterns (auto-detect trades file)
        shell: bash
        working-directory: ${{ github.workspace }}
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          set -euo pipefail

          # tenta pegar exatamente o nome esperado
          EXPECTED="results/backtest_trades_${{ inputs.symbol }}_${{ inputs.timeframe }}_long.csv"
          if [ -f "$EXPECTED" ]; then
            TRADES_FILE="$EXPECTED"
          else
            # fallback: pega o primeiro CSV encontrado
            TRADES_FILE="$(find . -type f -name "backtest_trades_*_long.csv" | sort | head -n 1 || true)"
          fi

          if [ -z "${TRADES_FILE}" ] || [ ! -f "${TRADES_FILE}" ]; then
            echo "ERRO: não encontrei o arquivo de trades. Veja listagem acima."
            exit 1
          fi

          echo "Usando TRADES_FILE=${TRADES_FILE}"
          python analyze_patterns.py \
            --trades "${TRADES_FILE}" \
            --min_trades "${{ inputs.min_trades }}"

      - name: Commit results/ to results branch
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          BRANCH="${{ inputs.results_branch }}"
          SYMBOL="${{ inputs.symbol }}"
          TF="${{ inputs.timeframe }}"
          RR="${{ inputs.rr_list }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -B "$BRANCH"

          git add results/

          if git diff --cached --quiet; then
            echo "No changes in results/. Nothing to commit."
            exit 0
          fi

          git commit -m "Backtest ${SYMBOL} ${TF} long (RR=${RR}) [run ${GITHUB_RUN_ID}]"
          git push origin "$BRANCH"
