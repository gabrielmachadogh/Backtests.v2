name: Backtest BTC 1h Long (PFR + DL)

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: "Símbolo (MEXC perp), ex: BTC_USDT"
        required: true
        default: "BTC_USDT"
      timeframe:
        description: "Timeframe (apenas 1h neste projeto)"
        required: true
        default: "1h"
      min_trades:
        description: "Min trades para relatórios de padrões"
        required: true
        default: "30"
      rr_list:
        description: "Lista de RRs (CSV), ex: 1.0,1.5,2.0,3.0"
        required: true
        default: "1.0,1.5,2.0,3.0"
  schedule:
    # roda todo dia 03:00 UTC (opcional)
    - cron: "0 3 * * *"

permissions:
  contents: read

jobs:
  run-backtest:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy requests
          fi

      - name: Run backtest
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python backtest.py \
            --symbol "${{ inputs.symbol || 'BTC_USDT' }}" \
            --timeframe "${{ inputs.timeframe || '1h' }}" \
            --only_long 1 \
            --max_entry_wait 1 \
            --rr_list "${{ inputs.rr_list || '1.0,1.5,2.0,3.0' }}"

      - name: Run analyze patterns
        shell: bash
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          python analyze_patterns.py \
            --trades "results/backtest_trades_${{ inputs.symbol || 'BTC_USDT' }}_${{ inputs.timeframe || '1h' }}_long.csv" \
            --min_trades "${{ inputs.min_trades || '30' }}"

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: results/

      - name: Upload data artifact (cache do histórico)
        uses: actions/upload-artifact@v4
        with:
          name: data
          path: data/
